@{
    ViewData["Title"] = "Projects Management";
}
@*@inject ProjectTracking.Data.Methods.Companies*@
@using ProjectTracking.Data.Methods.Interfaces

@*@inject ICompanies CompanyDtos*@

<div class="main-container">
    <h3 class="my-0">Projects</h3>
    <hr />
    <div id="ProjectManager" v-cloak>
        <div class="top-controls mb-5 " v-if="!isLoading">
            <table class="">
                <tr>
                    <td>
                        <label>Company</label>
                        <select v-model="companyId" class="form-control " style="max-width:200px">
                            <option value="0" disabled>Choose a Company</option>
                            <option v-for="company in companies" v-bind:value="company.id">
                                {{company.name}}
                            </option>
                            <option value="-1">Other</option>

                        </select>

                    </td>
                    <td>
                        <label>Department</label>

                        <select v-model="departmentId" class="form-control " style="max-width:200px">
                            <option value="0" disabled>Choose a Department</option>
                            <option v-for="department in departments" v-bind:value="department.id">
                                {{department.name}}
                            </option>
                            <option value="-1">Other</option>

                        </select>

                    </td>
                    <td>
                        <label></label>
                        <div>
                            <button class="btn Button-Shared "
                                    data-toggle="modal"
                                    :disabled="departmentId==0"
                                    data-target="#CreateProjModal"
                                    v-on:click="openAddModal(null)">
                                Create
                            </button>
                            <a asp-action="ProjectsProgress" class="Button-Shared"> Projects Progress</a>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td colspan="3">
                        <span v-show="companyId==0">
                            <small class="text-warning">
                                please choose a Company
                            </small>
                        </span>

                        <span v-show="departmentId==0 && companyId!=0">
                            <small class="text-warning">
                                please choose a department
                            </small>
                        </span>
                    </td>
                </tr>
            </table>
        </div>

        <div v-show="departmentId!=0 && !projectsLoading" class="table-controls" style="height:360px; overflow-y:scroll;">

            <section v-show="!projectsLoading" id="Pagination" v-bind:class="{ 'd-none':(dataPaging.totalPages < 2 )}">
                <div class="container">

                    <paginate :page-count="dataPaging.totalPages"
                              :container-class="dataPaging.pagination"
                              :prev-text="dataPaging.prev"
                              :next-text="dataPaging.next"
                              :click-handler="clickCallback">
                    </paginate>

                </div>
            </section>

            <div class="mb-4">
                <span v-on:click="expanddAll">
                    <img class="cell-arrow"
                         v-bind:class="{'rotate-Arrow' : areExpandAll}"
                         src="~/icons/arrow-down.svg" />
                </span><span><small class="ml-2">Expand/Collapse</small></span>
            </div>

            <span class="d-none">{{test}}</span>

            <table class="table border bg-light">
                <thead>
                    <tr>
                        <td>Activities</td>
                        <td>Title</td>
                        <td>Description</td>
                        <td>Date Added</td>
                        <td>Company</td>
                        <td>Department</td>
                        <td>Project Files</td>
                        <td></td>

                    </tr>
                </thead>
                <tbody>
                    <template v-for="project in projects">
                        <tr>
                            <td width="5px;"><span v-on:click="expandProject(project)"><img class="cell-arrow" v-bind:class="{'rotate-Arrow' : project.isExpanded }" src="~/icons/arrow-down.svg" /></span></td>
                            <td>
                                <span v-show="project.editMode && !project.editMode.active">{{project.title}}</span>
                                <input v-show="project.editMode &&  project.editMode.active" v-model="project.editMode.title">
                            </td>
                            <td>
                                <span v-show="!project.editMode.active">{{project.description}}</span>
                                <textarea v-show="project.editMode.active" v-model="project.editMode.description"></textarea>
                            </td>
                            <td>
                                <span>{{project.displayDate}}</span>
                            </td>
                            <td>
                                <select v-model="project.editMode.companyId" class="form-control " v-bind:disabled="!project.editMode.active">
                                    <option v-for="projectCompany in companies" v-bind:value="projectCompany.id" v-bind:selected="projectCompany.id==project.companyId">
                                        {{projectCompany.name}}
                                    </option>
                                </select>

                            </td>
                            <td>
                                <select v-model="project.editMode.departmentId" class="form-control " v-bind:disabled="!project.editMode.active">
                                    <option v-for="projectDepartment in departments" v-bind:value="projectDepartment.id" v-bind:selected="projectDepartment.id==project.departmentId">
                                        {{projectDepartment.name}}
                                    </option>
                                </select>
                            </td>
                            <td>
                                <button class="Button-Shared" type="button" v-on:click="openProjectFilesModal(project.id)">Files</button>
                            </td>
                            <td class="buttons-cell">
                                <span v-show="!project.editMode.active" v-on:click="toggleEditMode(project)">
                                    <img src="~/icons/edit(1).svg" />
                                </span>
                                <span v-show="project.editMode.active" v-on:click="editProject(project)">
                                    <img src="~/icons/check.svg" />
                                </span>
                                <span v-show="project.editMode.active" v-on:click="toggleEditMode(project)">
                                    <img src="~/icons/letter-x.svg" />
                                </span>
                                <span v-on:click="deleteProject(project.id)">
                                    <img src="~/icons/delete-button.svg" />
                                </span>

                                <a v-bind:href="`/projects/projectTrack?projectId=${project.id}`" class="Button-Shared Button-Small" >Track</a>

                            </td>

                        </tr>

                        <tr v-show="project.isExpanded && project.activities.length>0">
                            <td colspan="8">
                                <table class="table mb-1 border border-danger bg-transparent text-dark">
                                    <thead>
                                        <tr>
                                            <td></td>
                                            <td></td>
                                            <td>title</td>
                                            <td>Description</td>
                                            <td>dateAdded</td>
                                            <td>company</td>
                                            <td>department</td>
                                            <td>Activity Files</td>
                                            <td></td>

                                        </tr>
                                    </thead>
                                    <tbody>
                                        <template v-for="activity in project.activities">
                                            <tr>
                                                <td></td>
                                                <td></td>
                                                <td>
                                                    <span v-show="activity.editMode && !activity.editMode.active">
                                                        {{activity.title}}
                                                    </span>
                                                    <input v-show="activity.editMode &&  activity.editMode.active"
                                                           v-model="activity.editMode.title">
                                                </td>
                                                <td>
                                                    <span v-show="!activity.editMode.active">
                                                        {{activity.description}}
                                                    </span>
                                                    <textarea v-show="activity.editMode.active"
                                                           v-model="activity.editMode.description"></textarea>
                                                </td>
                                                <td>
                                                    <span>{{activity.displayDate}}</span>
                                                </td>
                                                <td>
                                                    <select v-model="activity.editMode.companyId" class="form-control " v-bind:disabled="!activity.editMode.active">
                                                        <option v-for="activityCompany in companies" v-bind:value="activityCompany.id" v-bind:selected="activityCompany.id==activity.companyId">
                                                            {{activityCompany.name}}
                                                        </option>
                                                    </select>

                                                </td>
                                                <td>
                                                    <select v-model="activity.editMode.departmentId" class="form-control " v-bind:disabled="!activity.editMode.active">
                                                        <option v-for="activityDepartment in departments" v-bind:value="activityDepartment.id" v-bind:selected="activityDepartment.id==activity.departmentId">
                                                            {{activityDepartment.name}}
                                                        </option>
                                                    </select>
                                                </td>
                                                <td>
                                                    <button class="Button-Shared" type="button" v-on:click="openProjectFilesModal(activity.id)">Files</button>
                                                </td>
                                                <td class="buttons-cell">
                                                    <span v-show="!activity.editMode.active" v-on:click="toggleEditMode(activity)">
                                                        <img src="~/icons/edit(1).svg" />
                                                    </span>
                                                    <span v-show="activity.editMode.active" v-on:click="editProject(activity)">
                                                        <img src="~/icons/check.svg" />
                                                    </span>
                                                    <span v-show="activity.editMode.active" v-on:click="toggleEditMode(activity)">
                                                        <img src="~/icons/letter-x.svg" />
                                                    </span>
                                                    <span v-on:click="deleteProject(activity.id,project)">
                                                        <img src="~/icons/delete-button.svg" />
                                                    </span>
                                                </td>

                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </td>
                        </tr>

                        <button class="btn Button-Shared ml-2 mb-3"
                                data-toggle="modal"
                                :disabled="departmentId==0"
                                data-target="#CreateProjModal"
                                type="button"
                                v-show="project.isExpanded"
                                v-on:click="openAddModal(project)">
                            add Activity
                        </button>
                    </template>
                </tbody>
            </table>

        </div>

        <div id="ProjectContents">
            <p v-if="isLoading">Loading...</p>
            <div v-if="!isLoading"></div>
        </div>
        <file-object-modal id="ProjectFilesModal" title="Project Files" v-bind:model="projectFiles"
                           v-on:add-click="addProjectFile" v-on:edit-click="editProjectFile"
                           v-on:cancel-click="cancelProjectFileEdit" v-on:update-click="updateProjectFile"
                           v-on:delete-click="deleteProjectFile">
        </file-object-modal>
        <!--Create Proj Modal -->
        <div id="CreateProjModal" class="modal fade" role="dialog">
            <div class="modal-dialog">
                <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title"></h4>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="usr">Title</label>
                            <input type="text" class="form-control" v-model="project.title">
                        </div>
                        <div class="form-group">
                            <label for="usr">Description</label>
                            <input type="text" class="form-control" v-model="project.description">
                        </div>
                        <div class="form-group">
                            <div v-show="errors.length>0">
                                <div v-for="error in errors" class="text-danger">
                                    {{error}}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" v-on:click="addProject">Add Project</button>
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>


    </div>
</div>


@section styles{
    <link href="~/css/Dashboard.min.css" rel="stylesheet" />

    <link href="~/css/projects.min.css" rel="stylesheet" />
}
@section scripts{

    <script src="https://unpkg.com/vuejs-paginate@latest"></script>
    <script src="~/services/ProjectFilesService.js"></script>
    <script src="~/js/projects-manager.js"></script>
}
